## لماذا هذا المنطق مفيد
- يعزل بيانات كل منشأة بالكامل بمنطق واضح (tenantId) ويحسّن الأمان.
- يبسّط تجربة البدء: إنشاؤها من شاشة الدخول بدون روابط دعوة أو انتظار بريد.
- يمنح المسؤول تحكّمًا مباشرًا بإنشاء المستخدمين (بريد + كلمة مرور + دور) بدل التعقيد البريدي.
- يسهّل التدقيق وتتبع العمليات لكل منشأة.

## نطاق التغيير
- الإبقاء على دخول البريد/كلمة المرور وإعادة تعيين كلمة المرور.
- إلغاء الدعوات بالبريد كليًا.
- إضافة إنشاء منشأة من شاشة الدخول وتعدد المستأجرين منطقيًا عبر `tenantId`.

## المعمارية المقترحة باختصار
- `tenants/{tenantId}`: تعريف المنشأة (الاسم، المالك، الإعدادات).
- `users/{uid}`: يضم `{email, roles, tenantId, managerDeptId}` فقط.
- بيانات التطبيق تحت `tenants/{tenantId}/...` (الأقسام، الموظفون، المؤشرات، السجلات، التقارير).

## خطوات تنفيذ عملية ومختصرة
1) إزالة الدعوات:
- حذف استخدام `invitations` في الكود والقواعد: `auth.js:120-139`, `script.js:2714-2725`, واجهة `index.html:1178-1181`, والقواعد `firestore.rules:16-21`.

2) مزامنة المستخدم/الدور:
- تعديل `syncUserRole` في `auth.js:120-161` ليعتمد فقط على `users/{uid}`.
- أول مستخدم يُنشأ للمنشأة يُمنح `['super_admin']`.

3) إنشاء منشأة من شاشة الدخول:
- إضافة تبويب بسيط يحوي اسم المنشأة + بريد وكلمة مرور للمالك.
- تنفيذ `registerOrganization()`: إنشاء `tenant`, إنشاء مستخدم مالك عبر `createUserWithEmailAndPassword`, ثم كتابة `users/{uid}` مع `tenantId` والدور.

4) إنشاء مستخدمين تابعين (بدون تبديل جلسة المسؤول):
- استبدال قسم الدعوة بزر "إنشاء مستخدم" (بريد + كلمة مرور + أدوار + قسم اختياري) في `index.html:1153-1181`.
- استخدام مثيل Auth ثانوي v8 لإنشاء الحساب دون التأثير على جلسة المسؤول.

5) فصل البيانات حسب المنشأة:
- نقل/استهداف جميع قراءات/كتابات التطبيق إلى `tenants/{tenantId}/...` اعتمادًا على `tenantId` المستخدم الحالي.

6) قواعد Firestore:
- إضافة دالة `userTenant(uid)` وفرض أن `resource.data.tenantId == userTenant(request.auth.uid)` لكل المجموعات.
- إدارة `users` محصورة لمن لديهم `roles.hasAny(['super_admin','admin'])` وضمن نفس `tenantId`.

## اختبار سريع
- إنشاء منشأة جديدة والدخول كمالك.
- إنشاء مستخدم جديد من لوحة الأدوار؛ دخول المستخدم والتأكّد من عزلة البيانات.
- محاولة قراءة بيانات منشأة أخرى للتأكد من رفض القواعد.

## مراجع سريعة للكود الحالي
- تهيئة Firebase: `firebase-config.js:33-39`.
- تسجيل/دخول المستخدم: `auth.js:209-240`, `auth.js:266-302`.
- مزامنة الدور: `auth.js:120-161`.
- واجهة الدعوات الحالية: `index.html:1153-1181`.
- منطق الدعوة: `script.js:2714-2725`.
- قواعد الدعوات: `firestore.rules:16-21`.

هل نبدأ بتنفيذ هذه الخطة المختصرة؟